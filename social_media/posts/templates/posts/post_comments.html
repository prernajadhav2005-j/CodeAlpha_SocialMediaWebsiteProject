{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4 col-md-6">

  <!-- ================= COMMENTS ================= -->
  <div class="card shadow-sm">
    <div class="card-body">

      <h5 class="fw-bold mb-3">Comments</h5>

      <!-- COMMENTS LIST -->
      <div id="comments-list" class="mb-3">
        {% for comment in post.comment_set.all %}
          <div class="mb-2">
            <b>{{ comment.user.username }}</b>: {{ comment.text }}
          </div>
        {% empty %}
          <p class="text-muted">No comments yet</p>
        {% endfor %}
      </div>

      <!-- ADD COMMENT FORM -->
      <form id="comment-form">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Add a comment..." name="text" required>
          <button class="btn btn-primary" type="submit">Post</button>
        </div>
      </form>

    </div>
  </div>

</div>

<!-- ================= AJAX ================= -->
<script>
function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(";").forEach(cookie => {
    cookie = cookie.trim();
    if (cookie.startsWith(name + "=")) {
      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
    }
  });
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

/* ================= COMMENT ================= */
document.getElementById("comment-form").addEventListener("submit", function(e){
  e.preventDefault();

  const input = this.querySelector("input[name='text']");
  const postId = "{{ post.id }}";

  fetch(`/posts/comment/${postId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrftoken,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `text=${encodeURIComponent(input.value)}`
  })
  .then(res => res.json())
  .then(data => {
    // Append new comment
    const commentsList = document.getElementById("comments-list");
    const newComment = document.createElement("div");
    newComment.classList.add("mb-2");
    newComment.innerHTML = `<b>${data.username}</b>: ${data.text}`;
    commentsList.appendChild(newComment);

    // Clear input
    input.value = "";
  });
});
</script>

{% endblock %}
