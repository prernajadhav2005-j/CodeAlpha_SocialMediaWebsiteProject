{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container">

<!-- ================= PROFILE CARD BOX (OUTSIDE ONLY) ================= -->
<div class="d-flex justify-content-center">
  <div class="shadow rounded-4 p-3 bg-white" style="max-width:900px; width:100%;">

    <!-- COVER IMAGE -->
    <div class="position-relative mb-5">
      <img
        src="{{ profile_user.profile.cover.url }}?v={{ request.GET.updated|default:0 }}"
        class="w-100 rounded"
        style="height:260px; object-fit:cover;"
      >

      <!-- PROFILE IMAGE -->
      <img
        src="{{ profile_user.profile.image.url }}?v={{ request.GET.updated|default:0 }}"
        class="rounded-circle border position-absolute"
        style="width:140px; height:140px; bottom:-70px; left:30px; object-fit:cover;"
      >
    </div>

    <!-- USER INFO (unchanged completely) -->
    <div class="mt-5 ms-3 text-center">
      <h4 class="fw-bold">üë§ {{ profile_user.username }}</h4>

      <p class="text-muted">{{ profile_user.profile.bio|default:"No bio added yet." }}</p>

      <!-- FOLLOWERS / FOLLOWING -->
      <div class="d-flex justify-content-center gap-3 mt-3">
        <a href="{% url 'accounts:followers' profile_user.username %}" class="btn btn-outline-primary btn-sm fw-bold">
          üë• Followers <span id="followers-count" class="fw-bold">{{ profile_user.followers.count }}</span>
        </a>
        <a href="{% url 'accounts:following' profile_user.username %}" class="btn btn-outline-success btn-sm fw-bold">
          ‚ûï Following <span class="fw-bold">{{ profile_user.following.count }}</span>
        </a>
      </div>

      <!-- EDIT / FOLLOW BUTTON -->
      <div class="mt-3">
        {% if request.user == profile_user %}
          <a href="{% url 'accounts:edit_profile' %}" class="btn btn-outline-primary btn-sm fw-bold">‚úèÔ∏è Edit Profile</a>
        {% else %}
          {% if user.is_authenticated %}
            <button
              class="btn btn-sm follow-btn {% if profile_user.id in following_ids %}btn-outline-danger{% else %}btn-outline-success{% endif %} fw-bold"
              data-user-id="{{ profile_user.id }}">
              {% if profile_user.id in following_ids %} Unfollow {% else %} Follow {% endif %}
            </button>
          {% endif %}
        {% endif %}
      </div>

      <!-- ================= DELETE ACCOUNT BUTTON (BOTTOM-RIGHT NEW STYLE) ================= -->
  {% if request.user == profile_user %}
  <div class="d-flex justify-content-end mt-3">
      <button 
          class="btn btn-outline-primary btn-sm fw-bold"
          onclick="confirmDelete()">
          üóëÔ∏è Delete My Account
      </button>
  </div>
  {% endif %}
  <!-- ===================================================================== -->

    </div>

  </div>
</div>

  <!-- ================= POSTS (unchanged) ================= -->
  <div class="row mt-4">
    <div class="col-md-8 mx-auto">

      {% for post in posts %}
      <div class="card mb-4 shadow-sm rounded-3">
        <div class="card-body">

          <!-- USERNAME -->
          <a href="{% url 'accounts:profile' post.author.username %}" class="fw-bold text-dark text-decoration-none mb-2 d-block">
            üë§ {{ post.author.username }}
          </a>

          <!-- POST CONTENT -->
          {% if post.content %}
            <p class="mt-2">{{ post.content }}</p>
          {% endif %}

          <!-- POST IMAGE -->
          {% if post.image %}
            <img src="{{ post.image.url }}" class="img-fluid rounded mb-2">
          {% endif %}

          <!-- POST VIDEO -->
          {% if post.video %}
            <video controls class="w-100 rounded mb-2">
              <source src="{{ post.video.url }}">
              Your browser does not support the video tag.
            </video>
          {% endif %}

          <!-- ACTION BUTTONS -->
          <div class="d-flex align-items-center gap-2 mb-2">
            <button class="btn btn-light btn-sm p-1 like-btn fw-bold" data-id="{{ post.id }}">
              ‚ù§Ô∏è <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
            </button>

            <button class="btn btn-light btn-sm p-1 comment-btn fw-bold" data-id="{{ post.id }}" data-bs-toggle="modal" data-bs-target="#commentModal">
              üí¨
            </button>

            {% if request.user == post.author %}
              <a href="{% url 'posts:edit_post' post.id %}" class="btn btn-light btn-sm p-1 fw-bold">‚úèÔ∏è</a>
              <a href="{% url 'posts:delete_post' post.id %}" class="btn btn-light btn-sm p-1 fw-bold" onclick="return confirm('Are you sure?');">üóëÔ∏è</a>
            {% endif %}
          </div>

          <p class="text-muted small">‚è∞ {{ post.created|timesince }} ago</p>

        </div>
      </div>
      {% empty %}
        <p class="text-center text-muted">No posts yet</p>
      {% endfor %}

    </div>
  </div>

</div>

<!-- COMMENT MODAL -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold">üí¨ Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="modal-comments-list" class="mb-3" style="max-height:300px; overflow-y:auto;"></div>

        <form id="modal-comment-form">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Add a comment..." name="text" required>
            <button class="btn btn-primary fw-bold" type="submit">üì® Post</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script src="{% static 'js/follow.js' %}"></script>

<script>
const csrftoken = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken=')).split('=')[1];

// LIKE BUTTON AJAX
document.addEventListener("click", function(e){
  const btn = e.target.closest(".like-btn");
  if(!btn) return;

  fetch(`/posts/toggle-like/${btn.dataset.id}/`, {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken}
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById(`like-count-${btn.dataset.id}`).innerText = data.count;
  });
});

// COMMENT MODAL
let currentPostId = null;
const modalCommentsList = document.getElementById("modal-comments-list");
const modalCommentInput = document.querySelector("#modal-comment-form input[name='text']");

document.querySelectorAll(".comment-btn").forEach(btn=>{
  btn.addEventListener("click", function(){
    currentPostId = this.dataset.id;
    modalCommentsList.innerHTML = "Loading...";

    fetch(`/posts/get_comments/${currentPostId}/`)
      .then(res => res.json())
      .then(data => {
        modalCommentsList.innerHTML = '';
        if(data.comments.length === 0){
          modalCommentsList.innerHTML = '<p class="text-muted">No comments yet</p>';
        } else {
          data.comments.forEach(c => {
            const div = document.createElement("div");
            div.classList.add("mb-2");
            div.innerHTML = `<b>üë§ ${c.username}</b>: ${c.text}`;
            modalCommentsList.appendChild(div);
          });
        }
        modalCommentsList.scrollTop = modalCommentsList.scrollHeight;
        modalCommentInput.focus();
      });
  });
});

// ADD COMMENT AJAX
document.getElementById("modal-comment-form").addEventListener("submit", function(e){
  e.preventDefault();
  if(!currentPostId) return;

  const input = modalCommentInput;

  fetch(`/posts/add-comment/${currentPostId}/`, {
    method:"POST",
    headers:{
      "X-CSRFToken": csrftoken,
      "Content-Type":"application/x-www-form-urlencoded"
    },
    body:`text=${encodeURIComponent(input.value)}`
  })
  .then(res => res.json())
  .then(data => {
    if(data.error){
      alert("Failed to post comment");
      return;
    }
    const div = document.createElement("div");
    div.classList.add("mb-2");
    div.innerHTML = `<b>üë§ ${data.username}</b>: ${data.text}`;
    modalCommentsList.appendChild(div);

    modalCommentsList.scrollTop = modalCommentsList.scrollHeight;
    input.value = "";
    input.focus();
  });
});

document.getElementById('commentModal').addEventListener('shown.bs.modal', function () {
  modalCommentInput.focus();
});

// ================= DELETE ACCOUNT CONFIRMATION =================
function confirmDelete() {
    if (confirm("Are you sure you want to permanently delete your account? This action cannot be undone.")) {
        window.location.href = "{% url 'accounts:delete_account' %}";
    }
}
</script>

{% endblock %}
